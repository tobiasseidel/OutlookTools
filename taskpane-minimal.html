<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Mail Reader</title>
  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
  <style>
    body { font-family: system-ui, sans-serif; margin: 1rem; }
    pre { white-space: pre-wrap; word-break: break-word; background:#f6f8fa; padding: 0.75rem; border-radius:8px; font-size: 0.875rem; max-height: 300px; overflow-y: auto; }
    button { padding: 0.5rem 0.75rem; margin-bottom: 0.5rem; margin-right: 0.5rem; }
    input { padding: 0.5rem; margin-bottom: 0.5rem; width: 100%; box-sizing: border-box; }
    .status { font-size: 0.875rem; color: #666; margin-bottom: 1rem; }
    .error { color: #dc3545; }
    .success { color: #28a745; }
    .section { margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid #eee; }
  </style>
</head>
<body>
  <h3>Mail Reader + API Test</h3>
  <div class="status" id="status">L√§dt Office.js...</div>
  
  <div class="section">
    <h4>1. API Konfiguration</h4>
    <label>API URL:</label>
    <input type="text" id="api-url" value="http://localhost:8000" placeholder="http://localhost:8000">
    <button id="test-api">üîå API Verbindung testen</button>
  </div>
  
  <div class="section">
    <h4>2. E-Mail lesen</h4>
    <button id="read">üì¨ Mail lesen</button>
    <button id="send-to-api">üöÄ An API senden</button>
  </div>
  
  <div class="section">
    <h4>Ausgabe:</h4>
    <pre id="out">Noch nichts geladen.</pre>
  </div>
  
  <script>
(function(){
  let emailData = null;
  
  function log(obj){
    const outElement = document.getElementById('out');
    if (outElement) {
      outElement.textContent = typeof obj === 'string' ? obj : JSON.stringify(obj, null, 2);
    }
  }
  
  function updateStatus(msg, type = 'status'){
    const statusEl = document.getElementById('status');
    if (statusEl) {
      statusEl.textContent = msg;
      statusEl.className = type;
    }
  }
  
  async function testAPI(){
    const apiUrl = document.getElementById('api-url').value;
    updateStatus('‚è≥ Teste API...', 'status');
    
    try {
      const response = await fetch(`${apiUrl}/api/test`);
      if (response.ok) {
        const data = await response.json();
        updateStatus('‚úÖ API erreichbar!', 'status success');
        log(data);
      } else {
        updateStatus(`‚ùå API Fehler: ${response.status}`, 'status error');
        log(`Fehler: ${response.status}`);
      }
    } catch (e) {
      updateStatus('‚ùå API nicht erreichbar', 'status error');
      log(`Fehler: ${e.message}\n\nPr√ºfen Sie:\n- L√§uft FastAPI auf ${apiUrl}?\n- CORS korrekt konfiguriert?`);
    }
  }
  
  function readEmail(){
    if (!Office.context || !Office.context.mailbox || !Office.context.mailbox.item) {
      updateStatus('‚ùå Keine E-Mail ge√∂ffnet', 'status error');
      log('Fehler: Kein Mail-Item verf√ºgbar.');
      return;
    }
    
    const item = Office.context.mailbox.item;
    emailData = {
      subject: item.subject || 'Kein Betreff',
      from_address: item.from ? (item.from.emailAddress || item.from.displayName) : 'Unbekannt',
      received_time: item.dateTimeCreated ? item.dateTimeCreated.toISOString() : new Date().toISOString()
    };
    
    if (item.body) {
      item.body.getAsync(Office.CoercionType.Text, function(result){
        if (result && result.status === Office.AsyncResultStatus.Succeeded) {
          emailData.body_preview = result.value ? result.value.slice(0, 1000) : '';
        }
        log(emailData);
        updateStatus('‚úÖ E-Mail gelesen', 'status success');
      });
    } else {
      log(emailData);
      updateStatus('‚úÖ E-Mail gelesen (Body nicht verf√ºgbar)', 'status success');
    }
  }
  
  async function sendToAPI(){
    if (!emailData) {
      updateStatus('‚ùå Keine E-Mail-Daten. Bitte zuerst Mail lesen!', 'status error');
      return;
    }
    
    const apiUrl = document.getElementById('api-url').value;
    updateStatus('‚è≥ Sende an API...', 'status');
    
    try {
      const response = await fetch(`${apiUrl}/api/process-email`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(emailData)
      });
      
      if (response.ok) {
        const result = await response.json();
        updateStatus('‚úÖ Erfolgreich verarbeitet!', 'status success');
        log(result);
      } else {
        updateStatus(`‚ùå API Fehler: ${response.status}`, 'status error');
        log(`Fehler: ${response.status}`);
      }
    } catch (e) {
      updateStatus('‚ùå Fehler beim Senden', 'status error');
      log(`Fehler: ${e.message}`);
    }
  }
  
  Office.onReady(function(info){
    updateStatus('‚úÖ Office.js geladen', 'status success');
    
    document.getElementById('test-api').onclick = testAPI;
    document.getElementById('read').onclick = readEmail;
    document.getElementById('send-to-api').onclick = sendToAPI;
  }).catch(function(err){
    updateStatus('‚ùå Office.onReady Fehler', 'status error');
    log('Fehler: ' + String(err));
  });
})();
  </script>
</body>
</html>
